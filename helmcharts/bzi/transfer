from typing import Dict
import pandas as pd
from fastapi import FastAPI, HTTPException
from sqlalchemy.orm import Session

app = FastAPI()

# Создаем соединение с базой данных
DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Создаем таблицы в базе данных
Base.metadata.create_all(bind=engine)

# Словарь соответствий таблиц и моделей
table_model_map = {
    'table1': Model1,
    'table2': Model2,
    'table3': Model3,
    'table4': Model4,
    'table5': Model5
}

def get_dataframes() -> Dict[str, pd.DataFrame]:
    # Ваш код для получения датафреймов
    pass

@app.post("/upload_data/")
def upload_data():
    dataframes = get_dataframes()

    with SessionLocal() as session:
        try:
            for table_name, df in dataframes.items():
                model = table_model_map.get(table_name)
                if model is None:
                    raise HTTPException(status_code=400, detail=f"Unknown table: {table_name}")

                # Преобразуем каждую строку датафрейма в объект модели
                records = [model(**record) for record in df.to_dict(orient='records')]
                session.bulk_save_objects(records)

            session.commit()
        except Exception as e:
            session.rollback()
            raise HTTPException(status_code=500, detail=str(e))

    return {"status": "Data uploaded successfully"}